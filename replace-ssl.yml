- name: Update SSL certificates proxmox ve
  hosts:
    - proxmox-ceph
  tasks:
    - name: Copy SSL certificate to host
      copy:
        src: "/tmp/ssl/*.discloud.nl_ecc/fullchain.cer"
        dest: "/etc/pve/local/pve-ssl.pem"

    - name: Copy SSL key to host
      copy:
        src: "/tmp/ssl/*.discloud.nl_ecc/*.discloud.nl.key"
        dest: "/etc/pve/local/pve-ssl.key"

    - name: Restart proxy service when certs change
      service:
        name: "pveproxy"
        state: restarted

- name: Update SSL certificates spam
  hosts:
    - spam
  vars:
    cert_path: "/tmp/ssl"
    cert_files:
      - "{{ cert_path }}/*.discloud.nl_ecc/fullchain.cer"
      - "{{ cert_path }}/*.discloud.nl_ecc/*.discloud.nl.key"
    output_file: "/tmp/pmg-tls.pem"
  tasks:
    - name: Combine SSL Certs
      copy:
        content: "{{ lookup('file', item) }}"
        dest: "{{ output_file }}"
      with_items: "{{ cert_files }}"
 
    - name: Copy SSL certificate to host
      copy:
        src: "/tmp/pmg-tls.pem"
        dest: "/etc/pmg/pmg-tls.pem"

    - name: Copy SSL key to host
      copy:
        src: "/tmp/pmg-tls.pem"
        dest: "/etc/pmg/pmg-api.pem"

    - name: Restart proxy service when certs change
      service:
        name: "pmgproxy"
        state: restarted

    - name: replace fingerprint on spam
      command: pmgcm update-fingerprint
